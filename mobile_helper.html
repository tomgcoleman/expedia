

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Bootstrap, Twitter's open source UI framework -->
    <!-- <link rel="stylesheet" href="https://twitter.github.io/bootstrap/assets/css/bootstrap.css"/> -->

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>

    <style>
        .remove_x {color: red; text-align: center}
        .remove_x:hover {color:blue; cursor: pointer; text-decoration: underline;}
        td {padding: 3px;}
        select {font-size: larger;}
        input {font-size: larger;}
        .btn {font-size: larger;}
        #add-optional-button {background-color: lightgreen;}
        #add-optional-key, #add-optional-value {background-color: lightgoldenrodyellow;}

    </style>
</head>
<body>
<div class="container">
    <form class="well">
        <fieldset>

            <label>Environment</label>
            <select id="environmentDropDown">
                <option value="">Live</option>
                <option value=".trunk.sb.karmalab.net" selected>trunk</option>
                <option value=".integration.sb.karmalab.net">RC</option>
                <option value=".int-milan.sb.karmalab.net">HF</option>
                <option value="pull_from_edit_box">local-host-ip</option>
                <option value=".chelwebestr34.bgb.karmalab.net">IS A</option>
                <option value=".chelwebestr09.bgb.karmalab.net">IS B</option>
                <option value=".trunk-stubbed.sb.karmalab.net">stub</option>
                <option value=".localhost">local</option>
                <option value=".sandbox.dev.sb.karmalab.net">Sandbox</option>
            </select>
            <input type="text" value="" id="local-host-ip"/><br>

            <br>
            <label>Point of Sale</label>
            <select id="POS">
                <option value="0">Select</option>
                <option value="www.expedia.com" selected>US - 1</option>
                <option value="www.expedia.com.au" >AU - 25</option>
                <option value="www.expedia.co.uk" >UK - 3</option>
                <option value="www.expedia.ca" >CA - 4</option>
                <option value="www.expedia.com.br" >BR - 69</option>
                <option value="www.expedia.de" >DE - 6</option>
                <option value="agence.voyages-sncf.com" >VSC - 7</option>
                <option value="www.expedia.it" >IT - 8</option>
                <option value="www.expedia.es" >ES - 9</option>
                <option value="www.expedia.nl" >NL - 11</option>
                <option value="www.expedia.mx" >MX - 12</option>
                <option value="www.travelocity.com" >TRV - 80001</option>
                <option value="www.travelocity.com" >TRC - 80004</option>
                <option value="www.expedia.com.sg" >SG - 14</option>
                <option value="www.expedia.com.my" >MY - 15</option>
                <option value="www.expedia.co.kr" >KR - 16</option>
                <option value="www.expedia.co.th" >TH - 17</option>
                <option value="www.expedia.com.hk" >HK - 18</option>
                <option value="www.expedia.fr" >FR - 20</option>
                <option value="www.expedia.co.in" >IN - 27</option>
                <option value="www.expedia.co.jp" >JP - 28</option>
                <option value="www.expedia.co.nz" >NZ - 29</option>
                <option value="www.wotif.com" >WAU - 70125</option>
                <option value="www.wotif.co.nz" >WNZ - 70129</option>
                <option value="www.cheaptickets.com" >CTK - 70301</option>
                <option value="www.orbitz.com" >ORB - 70201</option>
            </select><br>

            <label>Experiment ID</label>
            <input type="number" value="11358" id="experiment-id" size="4"/>
            <input id="see-bucket-button" type="button" class="update-button btn btn-primary" value="See Bucket.." />
            <br>

            <label>Experiment Name</label>
            <input type="text" value="name" id="experiment-name" size="25"/>
            <input id="store-experiment-button" type="button" class="update-button btn btn-primary" value="Remember Experiment in Table" />
            <br>

            <label>Treatment/Bucket</label>
            <input type="number" value="1" id="experiment-value" />
            <input id="set-bucket-button" type="button" class="update-button btn btn-primary" value="Set Bucket!" />
            <br>

            <label>Hotel ID</label>
            <input type="number" value="5" id="hotel-id"/>
            <input id="go-is-button" type="button" class="update-button btn btn-primary" value="Go to Infosite!" />
            <input id="go-is-trip-button" type="button" class="update-button btn btn-primary" value="Go to Infosite from Trip Advisor!" />
            <br>

            <label>City Name</label>
            <input type="text" value="Los Angeles" id="city-name"/>
            <input id="go-sr-button" type="button" class="update-button btn btn-primary" value="Search Results!" />
            <br>
            <input id="home-button" type="button" class="update-button btn btn-primary" value="Home Page." />

            <br><br>

            <input type='checkbox' id='checkbox-use-dates' checked="checked"/>
            <label for='checkbox-use-dates'>put dates in url</label>
            <input type="number" id='dates-offset' value='30' size='3'/>
            <input type="number" id='dates-duration' value='5' size='3'/>
            <br>
            <input type='checkbox' id='checkbox-create-link'  checked="checked"/>
            <label for='checkbox-create-link'>do not navigate, but show URL here</label>
            <br>
            <a id='inject-link-here' target="_tab" style="max-width=400px">.</a>
            <br>

            <p>
                <!-- <input id="mobile-on" type="button" class="update-button btn btn-primary" value="Turn On Mobile" /> -->
            <input id="clean-button" type="button" class="update-button btn btn-primary" value="Reset Abacus Overrides" />
            <br>
            <input id="unrand-button" type="button" class="update-button btn btn-primary" value="Turn off Random Abacus" />

            <table border="1">
                <tr>
                    <td>Experiments:<td>
                </tr>
                <tr class="experiment_row">
                    <td>13065</td>
                    <td>HIS home away amenity</td>
                </tr>
                <tr class="experiment_row">
                    <td>12445</td>
                    <td>HIS photo split screen</td>
                </tr>
                <tr class="experiment_row">
                    <td>11358</td>
                    <td>HSR skelliton</td>
                </tr>
                <tr class="experiment_row">
                    <td>13003</td>
                    <td>HSR urgency color</td>
                </tr>
                <tr class="experiment_row">
                    <td>13259</td>
                    <td>HSR remove star rating</td>
                </tr>
            </table>
            <table border="2">
                <tr>
                    <td>Hotels:<td>
                </tr>
                <!--<tr onclick="$('#hotel-id').val(5); $('#city-name').val('Los Angeles, CA')">-->
                <tr class="hotel_row">
                    <td>5</td>
                    <td>ESR : Sheraton</td>
                    <td>Los Angeles</td>
                </tr>
                <!--<tr onclick="$('#hotel-id').val(140596); $('#city-name').val('Las Vegas, Nevada')">-->
                <tr class="hotel_row">
                    <td>140596</td>
                    <td>ESR : Bellagio</td>
                    <td>Las Vegas</td>
                <!--<tr onclick="$('#hotel-id').val(4925017); $('#city-name').val('Mestre, Italy')">-->
                <tr class="hotel_row">
                    <td>1109673</td>
                    <td>ETP : later</td>  <!-- verified pay later -->
                    <td>Murcia Spain</td>
                </tr>
                <!--<tr onclick="$('#hotel-id').val(27566); $('#city-name').val('Santa Cruz, CA')">-->
                <tr class="hotel_row">
                    <td>27566</td>
                    <td>ETP : deposit</td>  <!--  verified hotel is deposit hotel -->
                    <td>LA California</td>
                </tr>
                <!--<tr onclick="$('#hotel-id').val(3893017); $('#city-name').val('Saudi Arabia')">-->
                <!--<tr class="hotel_row">-->
                    <!--<td>3893017</td>-->
                    <!--<td>Pegasus : Corp Exec</td>-->
                    <!--<td>Saudi Arabia</td>-->
                <!--</tr>-->
                <!--<tr onclick="$('#hotel-id').val(2281311); $('#city-name').val('Sold Out')">-->
                <tr class="hotel_row">
                    <td>16535</td>
                    <td>Sold Out</td>  <!-- verified sold out many months ahead -->
                    <td>Jalisco, Mexico</td>
                </tr>
                <!--<tr onclick="$('#hotel-id').val(2847); $('#city-name').val('Surfside, FL')">-->
                <tr class="hotel_row">
                    <td>1801</td>
                    <td>ETP : pay later</td>
                    <td>Niagara Falls Canada</td>
                </tr>
                <!--<tr onclick="$('#hotel-id').val(534776); $('#city-name').val('Kissimmee, FL')">-->
                <tr class="hotel_row">
                    <td>4855804</td>
                    <td>ESR 5 star</td>
                    <td>Ethiopia</td>
                </tr>
                <!--<tr onclick="$('#hotel-id').val(1831238); $('#city-name').val('Chicago, IL')">-->
                <tr class="hotel_row">
                    <td>22122</td>
                    <td>ETP deposit</td>
                    <td>Koloa Hawaii</td>
                </tr>
                <!--<tr onclick="$('#hotel-id').val(4049454); $('#city-name').val('Cloud, FL')">-->
                <tr class="hotel_row">
                    <td>1159107</td>
                    <td>ETP pay later</td>
                    <td>Granbury TX</td>
                </tr>
            </table>
            <table id="optional_arguments" border="1">
                <tr>
                    <th>apply item</th>
                    <th>url key</th>
                    <th>value</th>
                    <th>remove</th>
                </tr>
                <tr class="url_key_value_add_row">
                    <td>
                        <input id="add-optional-button" type="button" class="update-button btn btn-primary" value="add" />
                    </td>
                    <td>
                        <input type="text" value="key" id="add-optional-key"/>
                    </td>
                    <td>
                        <input type="text" value="value" id="add-optional-value"/>
                    </td>
                    <td class="remove_x">x</td>
                </tr>
                <tr class="url_key_value_row">
                    <td><input type="checkbox"/></td>
                    <td>qunit</td>
                    <td>1</td>
                    <td class="remove_x">x</td>
                </tr>
                <tr class="url_key_value_row">
                    <td><input type="checkbox"/></td>
                    <td>debugUITK</td>
                    <td>true</td>
                    <td class="remove_x">x</td>
                </tr>
                <tr class="url_key_value_row">
                    <td><input type="checkbox"/></td>
                    <td>dctkdebug</td>
                    <td>true</td>
                    <td class="remove_x">x</td>
                </tr>
                <tr class="url_key_value_row">
                    <td><input type="checkbox"/></td>
                    <td>bundling-debug</td>
                    <td>true</td>
                    <td class="remove_x">x</td>
                </tr>
                <tr class="url_key_value_row">
                    <td><input type="checkbox"/></td>
                    <td>debug</td>
                    <td>true</td>
                    <td class="remove_x">x</td>
                </tr>
            </table>
            . . . . click a row<br>
            * tablet may break when using this tool, i.e. empty hero, to recover:<br>
            1. minimize browsers by pressing the button<br>
            2. show processes by double clicking the button<br>
            3. enter kill mode via press and hold Safari icon<br>
            4. kill Safari by pressing the "-" on Safari<br>
            5. re-open Safari = should work fine.
        </fieldset>
    </form>
</div>
<script>
    function navigateToUrl( url ){
        var show_url = document.getElementById('checkbox-create-link').checked;
        if( show_url )
        {
            document.getElementById('inject-link-here').href = url;
            document.getElementById('inject-link-here').innerHTML = url;
        }
        else
        {
            window.open( url );
        }
    }

    function getEnvironment() {
        var prepped_domain = '';

        var environment_text = document.getElementById('environmentDropDown').value;
        var raw_domain = document.getElementById('POS').value;

        if (environment_text.length > 0) {
            raw_domain = raw_domain.replace(/\./g, '');
            prepped_domain = raw_domain + environment_text;
        } else {
            prepped_domain = raw_domain;
        }
        if (environment_text.match('pull_from_edit_box')) {
            prepped_domain = $('#local-host-ip').val();
        }
        return prepped_domain;
    }

    function generateUrlForSetBucket(environmentUrl, experimentId, experimentValue) {
        var experimentMiddle = 0;
        var experimentBucket = 0;
        var valueParts = experimentValue.split(/\D+/);
        if( valueParts ){
            if( valueParts.length > 0 ){
                experimentBucket = valueParts[0];
            }
            if( valueParts.length > 1 ){
                experimentMiddle = valueParts[0];
                experimentBucket = valueParts[1];
            }
        }
        return 'https://' + environmentUrl + '/tools/abacus/overrides?abov=' + experimentId + '|' + experimentMiddle + '|' + experimentBucket;
    }

    function generateUrlForSeeBucket(environmentUrl, experimentId) {
        return 'https://' + environmentUrl + '/tools/abacus/test?expid=' + experimentId;
    }

    function calculateDate(offset)
    {
        var date_result = {
            day: '01',
            month: '04',
            year: '2015'
        };

        try
        {
            var start_date = new Date();
            start_date.setDate( start_date.getDate() + offset );

            var day_start = start_date.getDate();
            if( day_start < 10 )
            {
                day_start = '0' + day_start;
            }
            var month_start = start_date.getMonth() + 1;
            if( month_start < 10 )
            {
                month_start = '0' + month_start;
            }
            var year_start = start_date.getYear() + 1900;

            date_result.day = day_start;
            date_result.month = month_start;
            date_result.year = year_start;
        }
        catch(e)
        {
            console.error('calcuate date offset: ' + e.message);
        }
        return date_result;
    }

    function generateUrlForTripAdvisor(hotelId) {
        /* https://wwwexpediacom.trunk.sb.karmalab.net/MobileHotel/Offers?hotelId=2163007&useCacheForAirAttach=false&checkInDate=2014-12-17&checkOutDate=2014-12-18&room1=2&chkin=5/17/2014&tpid=1&ICMDTL=htl.2163007.taid.1152288.geoid.60878.testslice..clickid.VH33wgokKGkAAE2kIzgAAAAS&chkout=5/18/2014&eapid=21187&mctc=9&paandi=true&rm1=a2&ICMCID=Meta.tripa.Expedia_US-MP */

        var environmentUrl = getEnvironment();
        var offset = document.getElementById('dates-offset').value;
        var duration = document.getElementById('dates-duration').value;
        var start_date = calculateDate( offset );
        var end_date = calculateDate( duration );

        return 'https://' + environmentUrl + '/MobileHotel/Offers?hotelId=' + hotelId +
                '&useCacheForAirAttach=false' +
                    // '&checkInDate=2015-5-17' +
                '&checkInDate=' + start_date.year + '-' + start_date.month + '-' + start_date.day +
                    // '&checkOutDate=2015-5-18' +
                '&checkOutDate=' +  + end_date.year + '-' + end_date.month + '-' + end_date.day +
                '&room1=2' +
                    // '&chkin=5/17/2015' +
                '&chkin=' + start_date.month + '/' + start_date.day + '/' + start_date.year +
                '&tpid=1&ICMDTL=htl.2163007.taid.1152288.geoid.60878.testslice..clickid.VH33wgokKGkAAE2kIzgAAAAS' +
                    // '&chkout=5/18/2015' +
                '&chkout=' + end_date.month + '/' + end_date.day + '/' + end_date.year +
                '&eapid=21187&mctc=9&paandi=true&rm1=a2&ICMCID=Meta.tripa.Expedia_US-MP' +
                gatherUrlKeyValues();
    }

    function generateUrlForIS(hotelId) {
        // https://www.expedia.com/go/hotel/info/12345/2017-04-19/2017-04-27?SrchCity=SEA&NumRoom=1&NumAdult-Room1=1

        var environmentUrl = getEnvironment();
        var offset = document.getElementById('dates-offset').value / 1;
        var duration = document.getElementById('dates-duration').value / 1;
        var start_date = calculateDate( offset );
        var end_date = calculateDate( offset + duration );

        var date_a = start_date.year + '-' + start_date.month + '-' + start_date.day;
        var date_b = end_date.year + '-' + end_date.month + '-' + end_date.day;

        var url = 'https://' + environmentUrl + '/go/hotel/info/' + hotelId + '/' + date_a + '/' + date_b + '?NumRoom=1&NumAdult-Room1=1';
        url += gatherUrlKeyValues();
        return url;
    }

    function generateUrlForSR(cityName) {
        // https://www.expedia.com/go?type=Hotel-Search&destination=NYC&daysInFuture=35&stayLength=8
        //             var end_date = calculateDate( offset + duration );

        var environmentUrl = getEnvironment();
        var offset = document.getElementById('dates-offset').value / 1;
        var duration = document.getElementById('dates-duration').value / 1;

        var url = 'https://' + environmentUrl + '/go?type=Hotel-Search&destination=' + cityName + '&daysInFuture=' + offset + '&stayLength=' + duration;
        url += gatherUrlKeyValues();
        return url;
    }

    $('#set-bucket-button').click(function() {
        var environmentUrl = getEnvironment();
        var experimentId = $('#experiment-id').val();
        var experimentValue = $('#experiment-value').val();

        navigateToUrl(generateUrlForSetBucket(environmentUrl, experimentId, experimentValue));
    });

    $('#see-bucket-button').click(function() {
        var environmentUrl = getEnvironment();
        var experimentId = $('#experiment-id').val();

        navigateToUrl(generateUrlForSeeBucket(environmentUrl, experimentId));
    });

    $('#store-experiment-button').click(function() {
        var experimentId = $('#experiment-id').val();
        var experimentName = $('#experiment-name').val();

        var saved_experiments = '{}';

        if (localStorage && localStorage.saved_experiments) {
            saved_experiments = localStorage.saved_experiments;
        }

        var saved_exp_obj = JSON.parse(saved_experiments);

        if (saved_exp_obj.exp_list) {
            for (var i = 0 ; i < saved_exp_obj.exp_list.length ; i++) {
                if (saved_exp_obj.exp_list[i].id == experimentId) {
                    // splice out the item
                    saved_exp_obj.exp_list.splice(i,1);
                    // put counter back to zero
                    i = i - 1;
                }
            }
        }

        if (saved_exp_obj && saved_exp_obj.exp_list && saved_exp_obj.exp_list.length > 5) {
            saved_exp_obj.exp_list.pop();
        }

        if (!saved_exp_obj.exp_list) {
            saved_exp_obj.exp_list = [];
        }

        saved_exp_obj.exp_list.unshift({
            id: experimentId,
            name: experimentName
        });

        localStorage.saved_experiments = JSON.stringify(saved_exp_obj);

        updateExperimentsFromLocalStorage();
    });

    $('#go-is-button').click(function() {
        var hotelId = $('#hotel-id').val();

        navigateToUrl(generateUrlForIS(hotelId));
    });

    $('#go-is-trip-button').click(function() {
        var hotelId = $('#hotel-id').val();

        navigateToUrl(generateUrlForTripAdvisor(hotelId));
    });

    $('#go-sr-button').click(function() {
        var cityName = $('#city-name').val();

        navigateToUrl(generateUrlForSR(cityName));
    });

    $('#mobile-off').click(function() {
        var mobileOffUrl = 'https://' + getEnvironment() + '/?stop_mobi=yes&rfrr=Mobile.Stop';
        navigateToUrl( mobileOffUrl );
    });

    $('#6248-HSR-HIS-Combined').click(function() {
        var bucketHsrHisCombined = 'https://' + getEnvironment() + '/tools/abacus/overrides?abov=6248|1|1';
        navigateToUrl( bucketHsrHisCombined );
    });

    $('#6172-HSR-Only').click(function() {
        var bucketHsrOnly = 'https://' + getEnvironment() + '/tools/abacus/overrides?abov=6172|1|1';
        navigateToUrl( bucketHsrOnly );
    });

    $('#6169-HIS-Only').click(function() {
        var bucketHisOnly = 'https://' + getEnvironment() + '/tools/abacus/overrides?abov=6169|1|1';
        navigateToUrl( bucketHisOnly );
    });


    $('#mobile-experiments').click(function() {
        var bucketMobileExperimentsUrl = 'https://' + getEnvironment() + '/tools/abacus/overrides?abov=4528|0|0:6060|0|1:6038|0|1:6043|0|1:6040|0|1:6050|0|1:5980|0|1:5983|0|1:6089|0|1:6132|0|1:-3|-1|-1:5226|0|1:5968|0|1:6006|0|1:6062|0|1:6063|0|1:6064|0|1';
        navigateToUrl( bucketMobileExperimentsUrl );
    });

    $('#clean-button').click(function() {
        var cleanUrl = 'https://' + getEnvironment() + '/tools/abacus/overrides?clean=1';
        navigateToUrl( cleanUrl );
    });

    $('#unrand-button').click(function() {
        var cleanUrl = 'https://' + getEnvironment() + '/tools/abacus/overrides?abov=-3|-1|-1';
        navigateToUrl( cleanUrl );
    });

    $('#home-button').click(function() {
        var homeUrl = 'https://' + getEnvironment();
        navigateToUrl( homeUrl );
    });

    $('.experiment_row').click(selectExperiment);
    $('.hotel_row').click(selectHotel);
//    $('.url_key_value_row').click(selectKeyValue);

    $('#add-optional-button').click(applyUrlKey);

    $('.remove_x').click(removeUrlKey);

    function selectHotel(evt) {
        var row = evt.target.parentElement;
        var hotel_id = row.children[0].innerHTML;
        $('#hotel-id').val(hotel_id);
        var city_name = row.children[2].innerHTML;
        $('#city-name').val(city_name);
    }
    function selectExperiment(evt) {
        console.log('select experiment');
        console.log(evt.target);
        console.log(evt.target.parentElement);

        // todo: check if this is row or cell

        var row = evt.target.parentElement;
        var exp_id = row.children[0].innerHTML;
        var exp_name = row.children[1].innerHTML;

        $('#experiment-id').val(exp_id);
        $('#experiment-name').val(exp_name);
    }

    function updateExperimentsFromLocalStorage() {
        var saved_exp_obj = {};
        if (localStorage && localStorage.saved_experiments) {
            saved_exp_obj = JSON.parse(localStorage.saved_experiments);
        }
        if (saved_exp_obj.exp_list) {
            for (var i = 0 ; i < saved_exp_obj.exp_list.length ; i++) {
                $('.experiment').eq(i).find('td').eq(0).text( saved_exp_obj.exp_list[i].id );
                $('.experiment').eq(i).find('td').eq(1).text( saved_exp_obj.exp_list[i].name );
            }
        }
    }
    updateExperimentsFromLocalStorage();

    function changeUrlKey(key, value) {
        var url_keys_obj = {};
        if (localStorage.url_keys) {
            url_keys_obj = JSON.parse(localStorage.url_keys);
        }
        if (url_keys_obj.item_list) {
            for (var i = 0 ; i < url_keys_obj.item_list.length ; i++) {
                if (key == url_keys_obj.item_list[i].key) {
                    url_keys_obj.item_list.splice(i,1);
                    i = i - 1;
                }
            }
        } else {
            url_keys_obj.item_list = [];
        }
        if (url_keys_obj.item_list.length > 4) {
            url_keys_obj.item_list.pop();
        }
        if (value) {
            url_keys_obj.item_list.unshift({
                key: key,
                value: value
            });
        }
        localStorage.url_keys = JSON.stringify(url_keys_obj);
        updateUrlKeys();
    }

    function applyUrlKey() {
        var key = $('#add-optional-key').val();
        var value = $('#add-optional-value').val();
        changeUrlKey(key, value);
    }

    function removeUrlKey(evt) {
        var row = evt.target.parentElement;
        var url_key = row.children[1].innerHTML;
        var url_value = row.children[2].innerHTML;
        changeUrlKey(url_key, '');
    }

    function updateUrlKeys() {
        var url_keys_obj = {};
        if (localStorage.url_keys) {
            url_keys_obj = JSON.parse(localStorage.url_keys);
        }
        var url_keys_rows = $('.url_key_value_row');
        if (url_keys_obj.item_list) {
            for (var i = 0 ; i < url_keys_obj.item_list.length && i < url_keys_rows.length ; i++) {
                var key = url_keys_obj.item_list[i].key;
                var value = url_keys_obj.item_list[i].value;

                url_keys_rows[i].children[1].innerHTML = key;
                url_keys_rows[i].children[2].innerHTML = value;
            }
        } else {
            url_keys_obj.item_list = [];
        }
    }
    function gatherUrlKeyValues() {
        var urlKeyValues = '';
        var url_keys_rows = $('.url_key_value_row');
        var url_key_value_checkboxes = $('.url_key_value_row input');
        for (var i = 0 ; i < url_keys_rows.length && i < url_keys_rows.length ; i++) {

            var checked = url_key_value_checkboxes.eq(i).is(":checked");
            var key = url_keys_rows[i].children[1].innerHTML;
            var value = url_keys_rows[i].children[2].innerHTML;

            if (checked) {
                urlKeyValues += '&' + key + '=' + value;
            }
        }
        return urlKeyValues;
    }

    updateUrlKeys();

</script>
</body>
</html>
